import React, { useRef, useState } from 'react';
import { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Legend, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Cell, PieChart, Pie } from 'recharts';
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import ATSScore from './ATSScore';
import LearningPath from './LearningPath';
import CoverLetter from './CoverLetter';
import './Results.css';

function Results({ results, atsData, resumeKey, jobDescription }) {
  const resultsRef = useRef();
  const [showCoverLetter, setShowCoverLetter] = useState(false);
  const [coverLetterData, setCoverLetterData] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const { compatibility_score, skill_match, feedback } = results;

  const getScoreColor = (score) => {
    if (score >= 70) return '#4caf50';
    if (score >= 50) return '#ff9800';
    return '#f44336';
  };

  const getScoreLabel = (score) => {
    if (score >= 70) return 'Excellent Match';
    if (score >= 50) return 'Good Match';
    return 'Needs Improvement';
  };

  // Prepare radar chart data
  const radarData = [
    { category: 'Overall Score', value: compatibility_score, fullMark: 100 },
    { category: 'Skills', value: skill_match, fullMark: 100 },
    { category: 'Experience', value: compatibility_score * 0.8, fullMark: 100 },
    { category: 'Keywords', value: feedback.missing_keywords ? Math.max(0, 100 - feedback.missing_keywords.length * 15) : 100, fullMark: 100 },
  ];

  // Prepare bar chart data for matched vs missing skills
  const matched_count = feedback.matched_skills_count || 0;
  const missing_count = (feedback.missing_keywords || []).length;
  
  const skillsData = [
    { name: 'Matched', value: matched_count, color: '#4CAF50' },
    { name: 'Missing', value: missing_count, color: '#FF6B6B' },
  ];

  // Category breakdown pie chart
  const categoryData = [
    { name: 'Skills Match', value: skill_match, color: '#4CAF50' },
    { name: 'Experience', value: compatibility_score * 0.3, color: '#2196F3' },
    { name: 'Education', value: compatibility_score * 0.2, color: '#FF9800' },
  ];

  const downloadPDF = async () => {
    const element = resultsRef.current;
    const canvas = await html2canvas(element, { scale: 2 });
    const imgData = canvas.toDataURL('image/png');
    
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgWidth = 210;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save('resume-analysis-report.pdf');
  };

  const shareResults = () => {
    const { compatibility_score, skill_match } = results;
    const subject = encodeURIComponent('My Resume Analysis Results');
    const body = encodeURIComponent(
      `Check out my resume analysis results:\n\n` +
      `üìä Overall Compatibility: ${compatibility_score.toFixed(1)}%\n` +
      `üéØ Skill Match: ${skill_match.toFixed(1)}%\n\n` +
      `Key Strengths:\n${feedback.strengths?.slice(0, 3).map(s => `‚Ä¢ ${s}`).join('\n') || 'N/A'}\n\n` +
      `Areas to Improve:\n${feedback.improvements?.slice(0, 3).map(i => `‚Ä¢ ${i}`).join('\n') || 'N/A'}\n\n` +
      `Generated by Resume Analyzer - AWS Serverless Project`
    );
    
    // Open email client
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  };

  const generateCoverLetter = async () => {
    if (!resumeKey || !jobDescription) {
      alert('Missing resume or job description data');
      return;
    }

    setIsGenerating(true);
    try {
      const API_ENDPOINT = 'https://s0ogqkfqaf.execute-api.us-east-1.amazonaws.com';
      const response = await fetch(`${API_ENDPOINT}/generate-cover-letter`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          resume_key: resumeKey,
          job_description: jobDescription,
          company_name: 'the company'
        }),
      });

      const data = await response.json();
      
      if (response.ok && data.cover_letter) {
        setCoverLetterData(data.cover_letter);
        setShowCoverLetter(true);
      } else {
        alert('Failed to generate cover letter: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error generating cover letter:', error);
      alert('Failed to generate cover letter. Please try again.');
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="results-container">
      <div className="results-header">
        <h2 className="results-title">üìä Analysis Results</h2>
        <div className="action-buttons">
          <button className="download-btn" onClick={downloadPDF}>
            üì• Download PDF
          </button>
          <button className="email-btn" onClick={shareResults}>
            üìß Email Results
          </button>
          <button 
            className="cover-letter-btn" 
            onClick={generateCoverLetter}
            disabled={isGenerating}
          >
            {isGenerating ? '‚è≥ Generating...' : '‚úçÔ∏è Generate Cover Letter'}
          </button>
        </div>
      </div>
      <div ref={resultsRef}>

      {/* ATS Score */}
      {atsData && <ATSScore atsData={atsData} />}

      {/* Score Cards */}
      <div className="score-cards">
        <div className="score-card main-score">
          <div className="score-label">Overall Compatibility</div>
          <div
            className="score-value"
            style={{ color: getScoreColor(compatibility_score) }}
          >
            {compatibility_score.toFixed(1)}%
          </div>
          <div className="score-badge" style={{ background: getScoreColor(compatibility_score) }}>
            {getScoreLabel(compatibility_score)}
          </div>
        </div>

        <div className="score-card">
          <div className="score-label">Skill Match</div>
          <div
            className="score-value small"
            style={{ color: getScoreColor(skill_match) }}
          >
            {skill_match.toFixed(1)}%
          </div>
        </div>
      </div>

      {/* Interactive Charts */}
      <div className="charts-section">
        <div className="chart-container">
          <h3 className="section-title">üìà Performance Radar</h3>
          <ResponsiveContainer width="100%" height={300}>
            <RadarChart data={radarData}>
              <PolarGrid stroke="#ddd" />
              <PolarAngleAxis dataKey="category" style={{ fontSize: '12px' }} />
              <PolarRadiusAxis angle={90} domain={[0, 100]} />
              <Radar name="Your Score" dataKey="value" stroke="#6366f1" fill="#6366f1" fillOpacity={0.6} />
              <Legend />
            </RadarChart>
          </ResponsiveContainer>
        </div>

        {(matched_count > 0 || missing_count > 0) && (
          <div className="chart-container">
            <h3 className="section-title">üéØ Skills Coverage</h3>
            <p style={{ fontSize: '14px', color: '#666', marginTop: '5px', marginBottom: '15px' }}>
              {matched_count} skills matched, {missing_count} key skills missing
            </p>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={skillsData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip formatter={(value) => `${value} skills`} />
                <Bar dataKey="value" radius={[8, 8, 0, 0]}>
                  {skillsData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        )}

        <div className="chart-container">
          <h3 className="section-title">üéØ Category Breakdown</h3>
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie
                data={categoryData}
                dataKey="value"
                nameKey="name"
                cx="50%"
                cy="50%"
                outerRadius={100}
                label={({name, percent}) => `${name}: ${(percent * 100).toFixed(0)}%`}
              >
                {categoryData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
              </Pie>
              <Tooltip />
              <Legend />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Feedback Sections */}
      <div className="feedback-sections">
        {/* Strengths */}
        {feedback.strengths && feedback.strengths.length > 0 && (
          <div className="feedback-section strengths">
            <h3 className="section-title">
              <span className="icon">‚úÖ</span>
              Strengths
            </h3>
            <ul className="feedback-list">
              {feedback.strengths.map((strength, index) => (
                <li key={index}>{strength}</li>
              ))}
            </ul>
          </div>
        )}

        {/* Areas for Improvement */}
        {feedback.improvements && feedback.improvements.length > 0 && (
          <div className="feedback-section improvements">
            <h3 className="section-title">
              <span className="icon">üí°</span>
              Areas for Improvement
            </h3>
            <ul className="feedback-list">
              {feedback.improvements.map((improvement, index) => (
                <li key={index}>{improvement}</li>
              ))}
            </ul>
          </div>
        )}

        {/* Matched Skills */}
        {feedback.matched_skills && feedback.matched_skills.length > 0 && (
          <div className="feedback-section strengths">
            <h3 className="section-title">
              <span className="icon">‚úÖ</span>
              Matched Skills ({feedback.matched_skills.length})
            </h3>
            <div className="keyword-tags">
              {feedback.matched_skills.map((skill, index) => (
                <span key={index} className="keyword-tag matched">
                  {skill}
                </span>
              ))}
            </div>
          </div>
        )}

        {/* Missing Keywords */}
        {feedback.missing_keywords && Array.isArray(feedback.missing_keywords) && feedback.missing_keywords.length > 0 && (
          <div className="feedback-section keywords">
            <h3 className="section-title">
              <span className="icon">üîç</span>
              Missing Keywords ({feedback.missing_keywords.length})
            </h3>
            <div className="keyword-tags">
              {feedback.missing_keywords.filter(kw => kw && typeof kw === 'string').map((keyword, index) => (
                <span key={index} className="keyword-tag missing">
                  {keyword}
                </span>
              ))}
            </div>
            <p style={{ marginTop: '15px', color: '#666', fontSize: '0.9rem' }}>
              üí° Consider adding these keywords to your resume if you have relevant experience
            </p>
          </div>
        )}
      </div>

      {/* Learning Path Section */}
      <LearningPath missingSkills={feedback.missing_keywords || []} />
      
      </div>

      {/* Cover Letter Modal */}
      {showCoverLetter && coverLetterData && (
        <CoverLetter 
          coverLetter={coverLetterData} 
          onClose={() => setShowCoverLetter(false)} 
        />
      )}
    </div>
  );
}

export default Results;
